<!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="utf-8"><title>Admin - Cantina IMUH</title>
<style>
  body{font-family:Arial;background:#f4f4f4;margin:0}
  header{background:#2c3e50;color:#fff;padding:12px;text-align:center}
  .box{max-width:1100px;margin:16px auto;padding:12px}
  .form{background:#fff;padding:12px;border-radius:6px;margin-bottom:12px}
  input, button, select{padding:8px;margin-right:8px}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:6px;overflow:hidden}
  th{background:#34495e;color:#fff;padding:10px}
  td{padding:10px;border-bottom:1px solid #eee;text-align:center}
  .small{font-size:0.9rem;color:#666}
</style></head>
<body>
<header><h2>Painel Administrativo - Cantina IMUH</h2></header>
<div class="box">

  <div class="form">
    <strong>Inserir / Somar Produto (vai somar se jÃ¡ existir)</strong><br><br>
    <input id="prod_add_nome" placeholder="Produto">
    <input id="prod_add_categoria" placeholder="Categoria">
    <input id="prod_add_qtd" type="number" placeholder="Quantidade">
    <input id="prod_add_imagem" placeholder="URL da imagem (opcional)">
    <button id="btnAdd">Inserir / Somar</button>
  </div>

  <div class="form">
    <strong>Atualizar Estoque (overwrite)</strong><br><br>
    <input id="produtoNome" placeholder="Nome do produto">
    <input id="novoEstoque" type="number" placeholder="Quantidade">
    <button id="btnSalvar">Salvar</button>
  </div>

  <h3>ðŸ“¦ Produtos (BANCO agregados)</h3>
  <table id="tabelaProdutos"><thead><tr><th>Produto</th><th>Categoria</th><th>Quantidade</th><th>Data</th></tr></thead><tbody></tbody></table>

  <h3 style="margin-top:20px">ðŸ“¨ Pedidos Recebidos</h3>
  <table id="tabelaPedidos"><thead><tr><th>Data</th><th>Nome</th><th>Produto</th><th>Qtd</th><th>Modo</th></tr></thead><tbody></tbody></table>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyUOd_WiLXBB2HSBKRO_L7myAFrSItdpzevnZa2YNXvaablV0bGj6ld8syLh8nJnmYmiQ/exec"; // <<== cole o /exec

async function carregarProdutos(){
  try{
    const res = await fetch(API_URL + "?action=produtos");
    const json = await res.json();
    const tbody = document.querySelector("#tabelaProdutos tbody");
    tbody.innerHTML = "";
    (json.rows||[]).forEach(r=>{
      const tr = document.createElement("tr");
      const data = r.DATA ? new Date(r.DATA).toLocaleString() : "";
      tr.innerHTML = `<td>${r.PRODUTO||""}</td><td>${r.CATEGORIA||""}</td><td>${r.QUANTIDADE||0}</td><td class="small">${data}</td>`;
      tbody.appendChild(tr);
    });
  }catch(err){ console.error(err); alert("Erro ao carregar produtos"); }
}

async function carregarPedidos(){
  try{
    const res = await fetch(API_URL + "?action=pedidos");
    const json = await res.json();
    const tbody = document.querySelector("#tabelaPedidos tbody");
    tbody.innerHTML = "";
    (json.rows||[]).forEach(r=>{
      const dt = r.DATA ? new Date(r.DATA).toLocaleString() : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${dt}</td><td>${r.NOME||""}</td><td>${r.PRODUTO||""}</td><td>${r.QUANTIDADE||0}</td><td>${r.MODO||""}</td>`;
      tbody.appendChild(tr);
    });
  }catch(err){ console.error(err); alert("Erro ao carregar pedidos"); }
}

document.getElementById("btnSalvar").addEventListener("click", async ()=>{
  const produto = document.getElementById("produtoNome").value.trim();
  const quantidade = Number(document.getElementById("novoEstoque").value);
  if(!produto || isNaN(quantidade)){ alert("Preencha corretamente"); return; }
  try{
    const params = new URLSearchParams();
    params.append("action","atualizarEstoque");
    params.append("produto", produto);
    params.append("quantidade", String(quantidade));
    const res = await fetch(API_URL, { method:"POST", body: params });
    const json = await res.json();
    if(json.success){ alert("Estoque atualizado"); carregarProdutos(); }
    else alert("Erro: " + (json.error|| JSON.stringify(json)));
  }catch(err){ console.error(err); alert("Falha ao atualizar"); }
});

document.getElementById("btnAdd").addEventListener("click", async ()=>{
  const produto = document.getElementById("prod_add_nome").value.trim();
  const categoria = document.getElementById("prod_add_categoria").value.trim();
  const quantidade = Number(document.getElementById("prod_add_qtd").value);
  const imagem = document.getElementById("prod_add_imagem").value.trim();
  if(!produto || isNaN(quantidade)){ alert("Preencha corretamente"); return; }
  try{
    const params = new URLSearchParams();
    params.append("action","addProduct");
    params.append("produto", produto);
    params.append("categoria", categoria);
    params.append("quantidade", String(quantidade));
    if(imagem) params.append("imagem", imagem);
    const res = await fetch(API_URL, { method:"POST", body: params });
    const json = await res.json();
    if(json.success){ alert(json.message || "OK"); 
      carregarProdutos(); 
      document.getElementById("prod_add_nome").value=""; document.getElementById("prod_add_qtd").value=""; document.getElementById("prod_add_categoria").value=""; document.getElementById("prod_add_imagem").value="";
    } else alert("Erro: "+(json.error||JSON.stringify(json)));
  }catch(err){ console.error(err); alert("Falha ao inserir"); }
});

carregarProdutos();
carregarPedidos();
</script>
</body>
</html>
