<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IMUH Cantina</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f7f7}
header{background:#ff0043;color:#fff;padding:12px;text-align:center;font-weight:700}
.layout{display:flex;gap:12px;padding:12px}
.main{flex:2}
.side{flex:1;min-width:300px}
.produtos{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06)}
.card img{width:100%;height:140px;object-fit:cover}
.card-body{padding:10px}
.actions{display:flex;gap:6px;margin-top:8px}
.add{background:#28a745;color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer}
.rem{background:#dc3545;color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer}
#carrinho{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-top:12px}
#itensCarrinho{max-height:220px;overflow:auto;margin-bottom:8px}
.btn-final{background:#007bff;color:#fff;padding:10px;border-radius:8px;border:none;cursor:pointer;width:100%}
select{width:100%;padding:8px;border-radius:6px;margin-top:8px}
.pendente{background:#fff7e6;padding:10px;border-radius:8px;margin-bottom:8px;border-left:5px solid #ffae00}
.btn-pagar{background:#007bff;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;margin-top:6px}
</style>
</head>
<body>
<header>üçΩÔ∏è IMUH Cantina</header>

<div class="layout">
  <div class="main">
    <div id="produtos" class="produtos"></div>

    <div id="carrinho">
      <h3>üõí Meu Carrinho</h3>
      <div id="itensCarrinho">(vazio)</div>
      <div style="margin-top:8px;font-weight:bold">Total: R$ <span id="totalCarrinho">0.00</span></div>

      <label style="display:block;margin-top:8px">Forma de Pagamento</label>
      <select id="pagamento">
        <option value="Pago">Pago</option>
        <option value="Pix">Pix</option>
        <option value="D√©bito">D√©bito</option>
        <option value="Cr√©dito">Cr√©dito</option>
        <option value="Pendente">Pendente</option>
      </select>

      <button id="finalizarBtn" class="btn-final" style="margin-top:10px">Finalizar Pedido</button>
      <div id="msg" style="margin-top:8px"></div>
    </div>
  </div>

  <aside class="side">
    <h3>üí∏ Pendentes</h3>
    <div id="listaPendentes">Carregando...</div>
  </aside>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyUOd_WiLXBB2HSBKRO_L7myAFrSItdpzevnZa2YNXvaablV0bGj6ld8syLh8nJnmYmiQ/exec";
let produtos=[],carrinho=[];

async function carregarPendentes(){
  try{
    const r=await fetch(API_URL+"?action=listPendentes");
    const data=await r.json();
    const div=document.getElementById("listaPendentes");
    div.innerHTML="";
    if(data.success&&data.pedidos.length>0){
      data.pedidos.forEach(p=>{
        const itens=p.itens.map(it=>`${it.nome} x${it.qtd}`).join("<br>");
        const node=document.createElement("div");
        node.className="pendente";
        node.innerHTML=`<b>${p.nome}</b><br>${itens}<br>üí∞ R$ ${Number(p.total).toFixed(2)}<br>
          <small>${p.data}</small><br>
          <button class="btn-pagar" onclick="marcarPago('${p.id}')">Marcar como Pago</button>`;
        div.appendChild(node);
      });
    }else div.innerHTML="Nenhum pendente.";
  }catch(e){document.getElementById("listaPendentes").innerText="Erro ao carregar pendentes";}
}

async function marcarPago(id){
  const metodo=prompt("Selecione a forma de pagamento: Pix, D√©bito, Cr√©dito ou Pago");
  if(!metodo)return;
  const url=`${API_URL}?action=updatePagamento&id=${id}&pagamento=${encodeURIComponent(metodo)}`;
  const r=await fetch(url);
  const data=await r.json();
  if(data.success){alert("‚úÖ Pedido marcado como pago!");carregarPendentes();}
  else alert("Erro: "+data.msg);
}

// demais fun√ß√µes do carrinho
async function carregarProdutos(){
  const r=await fetch(API_URL+"?action=listProdutos");
  const d=await r.json();produtos=d.produtos;renderProdutos();
}
function renderProdutos(){
  const el=document.getElementById("produtos");el.innerHTML="";
  produtos.forEach((p,i)=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<img src="${p.IMAGEM||'https://via.placeholder.com/400x300?text=Sem+Imagem'}">
      <div class="card-body"><h3>${p.PRODUTO}</h3><p>${p.CATEGORIA}</p><p>Estoque: <b id="estoque-${i}">${p.QUANTIDADE}</b></p>
      <p>R$ ${p.VALOR.toFixed(2)}</p>
      <div class="actions">
        <button class="add" onclick="adicionar(${i})">Ôºã</button>
        <button class="rem" onclick="removerProduto(${i})">Ôºç</button>
      </div></div>`;
    el.appendChild(c);
  });
}
function atualizarCarrinhoUI(){
  const el=document.getElementById("itensCarrinho");
  const tot=document.getElementById("totalCarrinho");
  el.innerHTML="";
  if(carrinho.length==0){el.textContent="(vazio)";tot.textContent="0.00";return;}
  let t=0;
  carrinho.forEach((it,idx)=>{
    t+=it.valor*it.qtd;
    const d=document.createElement("div");
    d.innerHTML=`${it.nome} x${it.qtd} - R$ ${(it.valor*it.qtd).toFixed(2)}`;
    el.appendChild(d);
  });
  tot.textContent=t.toFixed(2);
}
function adicionar(i){
  const p=produtos[i];if(p.QUANTIDADE<=0)return alert("Esgotado");
  const item=carrinho.find(x=>x.nome==p.PRODUTO);
  if(item)item.qtd++;else carrinho.push({nome:p.PRODUTO,qtd:1,valor:p.VALOR});
  p.QUANTIDADE--;document.getElementById("estoque-"+i).textContent=p.QUANTIDADE;
  atualizarCarrinhoUI();
}
function removerProduto(i){
  const p=produtos[i];
  const item=carrinho.find(x=>x.nome==p.PRODUTO);
  if(!item)return alert("Item n√£o no carrinho");
  item.qtd--;p.QUANTIDADE++;
  if(item.qtd<=0)carrinho=carrinho.filter(x=>x.nome!=p.PRODUTO);
  document.getElementById("estoque-"+i).textContent=p.QUANTIDADE;
  atualizarCarrinhoUI();
}

document.getElementById("finalizarBtn").addEventListener("click",async()=>{
  if(carrinho.length==0)return alert("Carrinho vazio");
  const nome=prompt("Digite seu nome:");
  if(!nome)return;
  const pagamento=document.getElementById("pagamento").value;
  const itens=carrinho.map(i=>({nome:i.nome,qtd:i.qtd,valor:i.valor}));
  const total=carrinho.reduce((s,i)=>s+i.qtd*i.valor,0);
  const url=`${API_URL}?action=novoPedido&nome=${encodeURIComponent(nome)}&itens=${encodeURIComponent(JSON.stringify(itens))}&total=${total}&pagamento=${pagamento}`;
  const r=await fetch(url);const data=await r.json();
  if(data.success){alert("‚úÖ Pedido enviado!");carrinho=[];carregarProdutos();atualizarCarrinhoUI();carregarPendentes();}
  else alert("Erro: "+data.msg);
});

carregarProdutos();
carregarPendentes();
</script>
</body>
</html>
